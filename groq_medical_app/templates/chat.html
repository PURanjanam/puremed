<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
  </head>
  <body class="light-green">
    <div class="d-flex align-items-start justify-content-center py-5">
      <div class="card chat-card shadow">
        <div class="card-header">
          <strong>AI Assistant</strong><br>
          <small>Patient: {{ patient.name }} â€¢ Joined: {{ patient.created_at }}</small>
        </div>
        <div class="card-body p-3">
          <div id="chat-box" class="chat-box mb-3">
            {% for m in history %}
              {% if m.role == 'user' %}
                <div class="text-end mb-2"><span class="badge bg-primary">You</span> <div class="d-inline-block chat-msg user-msg">{{ m.content }}</div></div>
              {% else %}
                <div class="mb-2"><span class="badge bg-success">AI</span> <div class="d-inline-block chat-msg ai-msg">{{ m.content }}</div></div>
              {% endif %}
            {% endfor %}
          </div>

          <div class="d-flex gap-2">
            <input id="msg" class="form-control" placeholder="Type a message...">
            <button id="send" class="btn btn-success">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const patientId = {{ patient.id }};
      const chatBox = document.getElementById("chat-box");
      document.getElementById("send").addEventListener("click", sendMessage);
      document.getElementById("msg").addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

      async function sendMessage(){
        const el = document.getElementById("msg");
        const text = el.value.trim();
        if (!text) return;
        // UI append user
        const userHtml = `<div class="text-end mb-2"><span class="badge bg-primary">You</span> <div class="d-inline-block chat-msg user-msg">${escapeHtml(text)}</div></div>`;
        chatBox.insertAdjacentHTML("beforeend", userHtml);
        chatBox.scrollTop = chatBox.scrollHeight;
        el.value = "";

        const res = await fetch("/api/send_message", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ patient_id: patientId, message: text })
        });
        const data = await res.json();
        const aiHtml = `<div class="mb-2"><span class="badge bg-success">AI</span> <div class="d-inline-block chat-msg ai-msg">${escapeHtml(data.reply)}</div></div>`;
        chatBox.insertAdjacentHTML("beforeend", aiHtml);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function escapeHtml(unsafe) {
        return unsafe.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
      }
    </script>
  </body>
</html>
